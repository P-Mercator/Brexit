#+TITLE: Brexit
#+AUTHOR: Pierre Mercatoris
#+PROPERTY: header-args:R  :session *brexit*
#+PROPERTY: header-args :cache yes 
#+PROPERTY: header-args :results output 
#+PROPERTY: header-args :exports results
#+OPTIONS: ^:nil

#+BEGIN_SRC R :exports none
  rm(list = ls())
  library(ggplot2)
  library(pastecs)
  library(ascii)
  library(GGally)
  library(gmodels)
                                          # allows to export tables to org
  options(asciiType="org")
  brexit <- read.csv("data/DataBrexit.csv")
                                          # remove warnings from outputs
  options(warn=-1)
                                          # options(warn=0)
#+END_SRC

#+RESULTS:
: -1

* TODO Introduction (1 page max., 0.5 pt)[0/3]
 - [ ] Describe briefly the topic of the Project and the motivations (which kind of information or evidences would you like to find out).
 - [ ] Describe briefly the data set: source and what are the data about.
 - [ ] define what is your target population and what is your sample (in the case that they are different). give the total sample size.

 
* TODO Description of variables and recoding (2 page max., 0.5 pt) [3/3]
  - [X] Describe each of the variables that you will analyze in this project. What are they and how are they measured.
  - [X] Mention the type of each variable, saying if it is qualitative or quantitative, and daulaepending on the case, nominal/ordinal or discrete/continuous.
  - [X] For variables with too many categories, try to reduce the number of categories by merging categories with similar meaning and recoding them. With fewer categories, interpretation is easier.
  
| Variable         | What?                   | How?                                 | Type                    |
|------------------+-------------------------+--------------------------------------+-------------------------|
| Region           | 12 regions of UK        | Wales, Scotland and Northern Ireland | Qualitative nominal     |
|                  |                         | are considered regions               |                         |
| Area             | Local authorities of UK | Brexit referendum                    | Qualitative nominal     |
| Pct_Leave        | % of vote to leave EU   | Brexit referendum                    | Quantitative continuous |
| Leave            | Pct_Leave over 50       | Categorised from Pct_Leave           | Qualitative nominal     |
| Mean.Age         | Mean age                | Age on 27th March 2011               | Quantitative continuous |
|                  |                         | Census 2011                          |                         |
| NoQualification  | % without any diploma   | Census 2011                          | Quantitative continuous |
| UniQualification | % with uni degree       | Census 2011                          | Quantitative continuous |
| Fluent           | % English proficient    | Census 2011                          | Quantitative continuous |
| Won.Parliament   | Party leading EPE       | EPE 2014                             | Qualitative nominal     |


#+BEGIN_SRC R :exports none
  brexit$Leave <- cut(brexit$Pct_Leave, c(0,50,100),labels=c("No","Yes"))
  head(brexit$Leave)
#+END_SRC

#+RESULTS:
| Yes |
| Yes |
| Yes |
| Yes |
| Yes |
| Yes |


* TODO Univariariate description (3 pages max., 2 pt)[2/2]
   - [X] Qualitative variables: Frequency tables, Barplots or Piechars.
   - [X] Quantitative variables: Frequency tables (intervals if continuous). Location measures (mean, median, quartiles), dispersion measures (variance, std. dev., CV, range, IQR), shape measures (asymmetry coefficients), Histogram or Boxplot.

  #+BEGIN_SRC R :results output raw
    ascii(summary(brexit[,-2],maxsum=12))
  #+END_SRC

  #+RESULTS:
  |    | Region                      | Pct_Leave     | Mean.Age      | NoQualification | UniQualification | Fluent        | Won.Parliament | Leave   |
  |----+-----------------------------+---------------+---------------+-----------------+------------------+---------------+----------------+---------|
  |  1 | East                    :47 | Min.   : 4.09 | Min.   :30.93 | Min.   :10.00   | Min.   :14.00    | Min.   :59.00 | Con : 84       | No :119 |
  |  2 | East Midlands           :40 | 1st Qu.:47.14 | 1st Qu.:38.79 | 1st Qu.:19.00   | 1st Qu.:22.00    | 1st Qu.:92.00 | Lab :100       | Yes:263 |
  |  3 | London                  :33 | Median :54.27 | Median :40.39 | Median :23.00   | Median :26.00    | Median :96.00 | LD  :  4       |         |
  |  4 | North East              :12 | Mean   :52.99 | Mean   :40.32 | Mean   :22.98   | Mean   :26.68    | Mean   :93.63 | SNP : 16       |         |
  |  5 | North West              :39 | 3rd Qu.:60.34 | 3rd Qu.:42.19 | 3rd Qu.:27.00   | 3rd Qu.:31.00    | 3rd Qu.:98.00 | UKIP:173       |         |
  |  6 | Northern Ireland        : 1 | Max.   :75.56 | Max.   :47.69 | Max.   :36.00   | Max.   :54.00    | Max.   :99.00 | NA's:  5       |         |
  |  7 | Scotland                :32 |               | NA's   :12    | NA's   :12      | NA's   :12       | NA's   :12    |                |         |
  |  8 | South East              :67 |               |               |                 |                  |               |                |         |
  |  9 | South West              :38 |               |               |                 |                  |               |                |         |
  | 10 | Wales                   :22 |               |               |                 |                  |               |                |         |
  | 11 | West Midlands           :30 |               |               |                 |                  |               |                |         |
  | 12 | Yorkshire and The Humber:21 |               |               |                 |                  |               |                |         |

** Qualitative variables


#+BEGIN_SRC R :results graphics :file "./pictures/regionPie.png"
  ggplot(brexit,aes(Region))+
    geom_bar(width = 1)+
    coord_polar()+
    labs( x = "Region", y = "Number of localities")
    # guides(fill=FALSE)
#+END_SRC

#+RESULTS:
[[file:./pictures/regionPie.png]]

#+BEGIN_SRC R  :results graphics :file "./pictures/noQualBar.png"
  ggplot(brexit,aes(Leave,fill = NoQualification))+
    geom_bar()+
    labs( x = "Wanting to leave the EU", y = "Number of localities")+
    guides(fill=FALSE)
#+END_SRC

#+RESULTS:
[[file:./pictures/noQualBar.png]]

#+BEGIN_SRC R  :results graphics :file "./pictures/epeBar.png"
  ggplot(na.omit(brexit),aes(Won.Parliament,fill = Won.Parliament))+
    geom_bar()+
    labs( x = "Leading party during EPE of 2014", y = "Number of localities")+
    guides(fill=FALSE)

#+END_SRC

#+RESULTS:
[[file:./pictures/epeBar.png]]

** Quantitative variables
#+BEGIN_SRC R :results output raw 
ascii(stat.desc(brexit[c("Pct_Leave","Mean.Age","UniQualification")],norm = TRUE, p = 0.95))
#+END_SRC

#+RESULTS:
|              | Pct_Leave | Mean.Age | UniQualification |
|--------------+-----------+----------+------------------|
| nbr.val      |    382.00 |   370.00 |           370.00 |
| nbr.null     |      0.00 |     0.00 |             0.00 |
| nbr.na       |      0.00 |    12.00 |            12.00 |
| min          |      4.09 |    30.93 |            14.00 |
| max          |     75.56 |    47.69 |            54.00 |
| range        |     71.47 |    16.75 |            40.00 |
| sum          |  20241.80 | 14918.74 |          9873.00 |
| median       |     54.27 |    40.39 |            26.00 |
| mean         |     52.99 |    40.32 |            26.68 |
| SE.mean      |      0.55 |     0.15 |             0.38 |
| CI.mean.0.95 |      1.08 |     0.29 |             0.74 |
| var          |    114.42 |     8.08 |            52.93 |
| std.dev      |     10.70 |     2.84 |             7.28 |
| coef.var     |      0.20 |     0.07 |             0.27 |
| skewness     |     -0.82 |    -0.33 |             0.93 |
| skew.2SE     |     -3.30 |    -1.30 |             3.67 |
| kurtosis     |      1.09 |     0.37 |             1.16 |
| kurt.2SE     |      2.19 |     0.73 |             2.30 |
| normtest.W   |      0.96 |     0.99 |             0.95 |
| normtest.p   |      0.00 |     0.01 |             0.00 |

#+BEGIN_SRC R :results graphics :file "./pictures/uniQualDis.png"
  ggplot(brexit,aes(UniQualification))+
    geom_histogram(aes(y = ..density..))+
    geom_density()+
    labs( x = "% of population holding university qualification", y = "Density")
#+END_SRC

#+NAME: graphic1
#+CAPTION: Hello
#+RESULTS:
[[file:./pictures/uniQualDis.png]]

#+BEGIN_SRC R :results graphics :file "./pictures/ageDis.png"
  ggplot(brexit,aes(Mean.Age))+
    geom_histogram(aes(y = ..density..))+
    geom_density()+
    labs( x = "Mean age", y = "Density")
#+END_SRC

#+RESULTS:
[[file:./pictures/ageDis.png]]

#+BEGIN_SRC R :results graphics :file "./pictures/fluentDis.png"
  ggplot(brexit,aes(Fluent))+
    geom_histogram(aes(y = ..density..))+
    geom_density()+
    labs( x = "% of population fluent in English", y = "Density")

#+END_SRC

#+RESULTS:
[[file:./pictures/fluentDis.png]]

#+BEGIN_SRC R  :results graphics :file "./pictures/leavePctDis.png"
  ggplot(brexit,aes(Pct_Leave))+
    geom_histogram(aes(y = ..density..))+
    geom_density()+
    labs( x = "% that voted to leave at Brexit", y = "Density")
#+END_SRC

#+RESULTS:
[[file:./pictures/leavePctDis.png]]

* TODO Bivariate description (5 pages max., 2 pt)[3/3]

 - [X] Both variables qualitative: Crossclassified table, tables with interesting conditional distributions, grouped or stacked barplots for those conditionals. Compare proportions in different groups.
 - [X] One qualitative, one quantitative: Compare the means, variances and CVs of the quantitative variable for each category of the other one. Compare histograms or boxplots of the quantitative variable for each category of the other one.
 - [X] Both quantitative: scatterplot, covariance, Pearson correlation coef., regression line of a target variable in terms of one/several explanatory variables.

** Both qualitative 

#+BEGIN_SRC R :results raw
  ascii(CrossTable(brexit$Won.Parliament,brexit$Leave))
#+END_SRC

#+RESULTS:



#+BEGIN_SRC R :exports results :results output raw
  ascii(ftable(table(brexit$Won.Parliament,brexit$Leave)))

#+END_SRC

#+RESULTS:
|      |   | No | Yes |
|------+---+----+-----|
|      |   |    |     |
| Con  |   | 43 |  41 |
| Lab  |   | 46 |  54 |
| LD   |   |  4 |   0 |
| SNP  |   | 16 |   0 |
| UKIP |   |  7 | 166 |

#+BEGIN_SRC R :results graphics :file "./pictures/epeNoQualBar.png"
  ggplot(na.omit(brexit),aes(Leave))+
    geom_bar(aes(fill = Won.Parliament),position="fill")+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
#+END_SRC

#+RESULTS:
[[file:./pictures/epeNoQualBar.png]]
 
#+BEGIN_SRC R :results graphics :file "./pictures/epeRegionBar.png"
  ggplot(na.omit(brexit),aes(Region))+
    geom_bar(aes(fill = Won.Parliament),position="fill")+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
#+END_SRC

#+RESULTS:
[[file:./pictures/epeRegionBar.png]]

#+BEGIN_SRC R :results graphics :file "./pictures/noQualRegionBar.png"
  ggplot(na.omit(brexit),aes(Region))+
    geom_bar(aes(fill = Leave),position="fill")+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
#+END_SRC

#+RESULTS:
[[file:./pictures/noQualRegionBar.png]]


** Qualitative and Quantitative

#+BEGIN_SRC R :results graphics :file "./pictures/QualQuanMatrics.png"

  plotList <- list()
  for (i in 1:12) {
    plotList[[i]] <- ggally_text(paste("Plot #", i, sep = ""))
  }
  plotList[[1]] <- ggplot(na.omit(brexit),aes(Region,Pct_Leave))+
    geom_boxplot()+
    geom_hline(linetype = 2,yintercept = 50,color="red")+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

  plotList[[4]] <- ggplot(na.omit(brexit),aes(Region,Mean.Age))+
    geom_boxplot()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

  plotList[[7]] <- ggplot(na.omit(brexit),aes(Region,UniQualification))+
    geom_boxplot()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

  plotList[[10]] <- ggplot(na.omit(brexit),aes(Region,Fluent))+
    geom_boxplot()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

  plotList[[2]] <- ggplot(na.omit(brexit),aes(Leave,Pct_Leave))+
    geom_boxplot()+
    geom_hline(linetype = 2,yintercept = 50,color="red")+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

  plotList[[5]] <- ggplot(na.omit(brexit),aes(Leave,Mean.Age))+
    geom_boxplot()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

  plotList[[8]] <- ggplot(na.omit(brexit),aes(Leave,UniQualification))+
    geom_boxplot()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

  plotList[[11]] <- ggplot(na.omit(brexit),aes(Leave,Fluent))+
    geom_boxplot()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
    
  plotList[[3]] <- ggplot(na.omit(brexit),aes(Won.Parliament,Pct_Leave))+
    geom_boxplot()+
    geom_hline(linetype = 2,yintercept = 50,color="red")+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

  plotList[[6]] <- ggplot(na.omit(brexit),aes(Won.Parliament,Mean.Age))+
    geom_boxplot()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

  plotList[[9]] <- ggplot(na.omit(brexit),aes(Won.Parliament,UniQualification))+
    geom_boxplot()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

  plotList[[12]] <- ggplot(na.omit(brexit),aes(Won.Parliament,Fluent))+
    geom_boxplot()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

  pm <- ggmatrix(
    plotList,
    nrow = 4, ncol = 3,
    yAxisLabels = c("Pct_Leave", "Mean.Age", "UniQualification","Fluent"),
    xAxisLabels = c("Region","Leave", "Won.Parliament"),
    title = "Matrix Title"
  )
  pm
#+END_SRC

#+RESULTS:
[[file:./pictures/QualQuanMatrics.png]]


** Both quantitative 

#+BEGIN_SRC R :results graphics :file "./pictures/QuanMatrics.png"
ggscatmat(brexit,columns = c ("Pct_Leave","Mean.Age","Fluent","UniQualification","NoQualification"),alpha = 0.5)  
#+END_SRC

#+RESULTS:
[[file:./pictures/QuanMatrics.png]]

* TODO Inference (2 pages max., 1 pt)[0/4]
 - [ ] Confidence interval for a difference of two proportion.
 - [ ] Hypothesis testing for the equality of two proportions.
 - [ ] Confidence interval for a difference of two means.
 - [ ] Hypothesis testing for equality of two means.
** Proportions 
*** Clear that people who voted UKIP at EPE wanted to leave 

 Compare 0.040 to 0.960 or 0.019 to 0.440

*** Did people voting Labour want to leave?

 Compare 0.460 to 0.540 or 0.122 to 0.143

** Sample means

* TODO Sampling (2 pages max., 1.5 pt)[0/2]
 - [ ] Treat your data as the population of interest and take a stratified sample using as strata the categories of one of the qualitative variable and applying simple random sampling within each strata. You first need to decide the total sample size. Secondly, you need to allocate this total sample size in the strata. Comment on the common methods for sample allocation that exist in the literature. Select your preferred method (justify your decision) and obtain the sample size within each stratum.
 - [ ] With the sample drawn in 7.1, estimate unbiasedly the population mean of a quantitative variable of interest. Estimate unbiasedly the population proportion of a qualitative variable. With the sample drawn in 7.1, estimate unbiasedly the means of a quantitative variable of interest for each stratum. Estimate unbiasedly the proportion of a qualitative variable for each stratum.
 - use random sample

* TODO Model selection (1 page max., 1 pt)[0/3]
 - [ ] Select the best probability distribution for at least one variable of interest. You might need to take some transformation (e.g. log).
 - [ ] Estimate the parameters of the distribution by the method of moments or by maximum likelihood.

* TODO Conclusions (2 pages max., 1.5 pt)[0/2]
 - [ ] Summarize the most important conclusions of your analyses.
 - [ ] Mention limitations and possible extensions of this project.

* References (if needed)
  List of documents referred to in the text of the report.
  


* IMPORTANT REMARKS:
- Free statistical analysis: Additional statistical analyses selected by the student that do not fit in the general structure listed above might be included. The maximum pages for this additional material will be 3. This material will be evaluated with a maximum of 2 additional points only if it is reasonable, correct and related with this subject.
- All tables, plots and statistical procedures must be clearly described (what are you doing, what is it in the x and y axis, etc) and conclusions (interesting or useful information) must be drawn from all of them. Tables and figures without any comment must be removed from the project report. If new plots that are different from those studied in class are included, they must be very clearly explained.
- These projects will be carefully read and graded. The redaction of the report must be original (do not copy any paragraph from any source unless you explicitly acknowledged it by including a reference to the original source). English expression must be understandable and clean of typos or grammar errors (e.g. –s in third person singular).
- Do not include the whole list of data in the Project report.



